\providecommand{\main}{..}					% fix bibliography path
\documentclass[\main/IO-Pixels.tex]{subfiles}
    
 \graphicspath{{\main/fig/tech-data/}}			% fix graphics path  
%======================================================================

\begin{document}
 
% All analysis carried out in R - code & support package available?
 
\section{Technical backgound \& data}
%----------------------------------------------------
\begin{outline}
Detector and X-ray technology

Details on data collections: 

- pilot data: bad pixel maps, mean and SD files)

  Perkin Elmer definitions of underperforming pixels and discussion
  
- experimental data: protocol for white image test data, usage data
\end{outline}
%----------------------------------------------------

\subsection{Technical background}

All of the detector images used in this paper were obtained from CCD panels manufactured by \textit{PerkinElmer}; although not all images were obtained from the same model, the basic design and operation of the detectors remains the same. Each panel consists of a 2048-square grid of photosensitive pixels, each having a width of \SI{200}{\micro\meter}, giving a total field of view of 40.96cm$^2$. The panel's electronics are located outside the perimeter of this region, where they are shielded from exposure to x-rays. Each detector panel is divided into subpanels, each 128 columns wide; the AN1621 detectors consist of two rows of 16 subpanels, each one 1024 pixels high, with electrical separation at the midline of the panel, while the AN1620 detector has only one row of 16 subpanels, spanning the full height of the panel. See  \cite{PerkinElmerManual} for more detail.

X-rays are generated by firing high-voltage electrons at a tungsten target, \nb{currently gleaned from Wikipedia, can Jay recommend a better citation?} and pass first through a beryllium screen \nb{which does... what?} and then through a scintillator - a sheet of caesium iodide - which converts the x-rays into visible light. These photons are detected by the photodiodes, which convert them into an electrical charge of corresponding magnitude. Each charge `packet' is transferred through a grid of thin-film transistors (TFT) by column drivers \nb{at intervals of 256 pixels?} along each column of pixels toward an analogue-to-digital converter (ADC) at the edge of the panel, where it is converted to a grey value (GV) using 16-bit compression, giving a range of possible grey values from 0 to 65535 for each pixel. The direction of charge transfer is shown in Figure~\ref{fig:charge-transfer-direction}.

%----------------------------------------------------
% direction of charge transfer
\begin{figure}[!ht]
\caption{\nb{rework fig so that it's actually legible} Direction of charge transfer in PerkinElmer AN1621. The direction of charge transfer in the AN1620 detector (image ref MCT225) is identical to that of the lower panel of the AN1621 detector \nb{double-check that this is the case!}}
\label{fig:charge-transfer-direction}
\includegraphics[scale=0.4]{data-readout}
\end{figure} 
%----------------------------------------------------

\addfigure{citations on this?}

A rim of 6 pixels around the edges of the detector is treated as an inactive area and assumed to be potentially unreliable, due to the known effects of mechanical stresses in this area. To counter this, all of the detector images used in the study have already been cropped to some degree by the operators.  However, since all images are taken from a panel of the same dimensions, all coordinates and plots will still refer to the $2048 \times 2048$ square so that they all occupy their true position within the panel area. All images are also presented in their correct orientation \nb{add caveat if any are rotated!}.
  
%----------------------------------------------------
% table of image references & sources
\begin{table}[!ht]
\caption{Summary of settings used for each acquisition, with date/time acquired, panel model, and power settings applied when obtaining each image (kV = voltage, uA = current; exp. = exposure time in $\mu s$ \nb{?}) The total power input is also calculated (in arbitrary units \nb{?}) for ease of comparison. \\ \footnotesize{The first 6 image sets comprise the `pilot data' set, the 14 sets acquired between October 2014 and July 2016 the `main data' set. All of these images were acquired from the same detector panel, which was refurbished on the dates indicated, and was replaced with the `loan' panel after this date due to a malfunctioning readout sensor affecting a whole subpanel. The remaining images were acquired singly from detectors kindly loaned from other institutions. All images were acquired with a Reflection 225 source and tungsten source target. \nb{different gain settings were used in obaining some of the images - check with Jay if this should be included - also, should we mention the different operators?}}}

\label{tab:xml-summ}
\resizebox{\textwidth}{!}{%
	\csvreader[tabular = c|cc|c|c|c cc|c|ccc|c|l, head to column names, late after line =, 
				before line = \ifthenelse{\equal{\hlflag}{}}{\\}{\\\hline}, before first line =,
				table head = &Acq. & Panel & &	 & \multicolumn{4}{c|}{Grey} & \multicolumn{4}{c|}{White} & \\
				  & ref  & ref & Timestamp & Model & \multicolumn{4}{c|}{\footnotesize{kV $\cdot$ uA $\cdot$ exp.} $=$ power} & \multicolumn{4}{c|}
				  {\footnotesize{kV $\cdot$ uA $\cdot$ exp.} $=$ power}  & Comments\\\hline]%
		{\main/fig/tech-data/Detector-details.csv}{}%
		{\head & \code & \panelid & \footnotesize{\timestamp} & \model & \footnotesize{\gkV} & \footnotesize{\guA} & \footnotesize{\gexp} & \gpower & 
			\footnotesize{\wkV} & \footnotesize{\wuA} & \footnotesize{\wexp} & \wpower & \footnotesize{\notes}}%
	}
\end{table}
%----------------------------------------------------

\subsection{Data format}


Each \textbf{acquisition} referred to in Table~\ref{tab:xml-summ} consists of sets of images taken at three different power settings, with no objects in the field of view:
\begin{description}

\item[Black (offset) images:] These dark images are taken with no exposure to an x-ray source; the GVs returned reveal the level of background electrical activity (the \textbf{dark current}) within the subpanel.
\item[Grey (mid-range) images:] These have a nominal mean GV of \nb{?}. The operator will manually adjust the power settings if necessary to obtain this nominal grey value. To explore the effect of defective pixels on the shading-corrected image, we will substitute the grey mid-range images for the `true' image $X$. If there are no significant defects in the panel, we should obtain a smooth grey image, with a low variance of pixel values.
\item[White (flood) images:] These images have a nominal mean GV of \nb{?}. Again, the operator may manually adjust the power settings in order to obtain this nominal value. The difference between the flood image and the offset image is the \textbf{gain}.
\end{description}

Where possible, an acquisition consists of 20 black, 20 grey and 20 white frames, taken consecutively in a short time period (typically, around 7 minutes for all 60 frames). We obtain a single averaged image of each type by taking the mean of 20 values from each pixel; unless stated otherwise, the subsequent analysis will be carried out on these black, grey and white pixelwise-mean images, which will be labelled $B$, $G$ and $W$ respectively. In the pilot data sets (rows 1-6 of the table), the raw frames were not available, and only summarised black, grey and white images produced by the detector software were provided, with the power settings used to obtain the grey images not recorded.

In real-world usage, the offset and flood images are used to correct the target image, accounting for differences in dark current and gain between pixels. Given an image $X$ of interest, a black offset image $B$, and a white flood image $W$, we obtain the \textbf{shading-corrected image}

\begin{equation}
	X_c = \frac{X -B}{W - B} \times 60000
\end{equation}
\nb{Do we really use 60000? or do we use mean gain value? - would be closer to 40k}

To explore the effect of defective pixels on the shading-corrected image, we will substitute the grey mid-range image $G$ for the `true' image $X$. If there are no defects in the panel, we should obtain a smooth grey image, with a low variance of pixel values.

\subsection{Defective pixels}

Over time, individual pixels (or, sometimes, whole regions of the detector) may begin to behave abnormally. This abnormal behaviour may take several forms: pixels may have a high dark current, registering an unusually high output at all power levels; they may fail to respond to the x-ray source, appearing normal in the black images but extremely dark in the grey and white images; they may become over- or under-sensitive to the x-ray spot. Moreover, defects may affect small clusters of pixels, partial or whole columns, and even (apparently very rarely) whole rows of pixels. Depending on its severity and nature, a defect may be removed when the shading correction is applied, but it may also remain as a bright or dark spot in the image. This problem is compounded when carrying out CT scanning (in which many images of an object, taken at different angles, are combined to reconstruct a 3d model of the object), since any defect will be `smeared' through the reconstructed model. It is therefore critical that the operator is able to identify defective pixels, in order to apply a further correction (often, a simple median-switching approach, in which a known defect is replaced with the median of the values in its local neighbourhood, is applied).

An underperforming pixel map is provided by the panel's manufacturer, with bad pixels classified according to a number of criteria based on pixel sensitivity, noise, and uniformity with its neighours - see Appendix~\ref{app:bpx-defn} for details. This pixel map can be produced at any time by the operator; usually after the installation of a new or refurbished detector, or if the operator is concerned that the detector is not operating as it should. The map actually consists of a set of 10 data files, summarised over 100 frames at each power setting \nb{who sets the power for these calibration images? If automatic, could it over-saturate?}:

\begin{itemize}
    \item mean black image $B$, along with corresponding pixelwise SDs, minima and maxima
    \vspace{- .8\baselineskip}
    \item mean grey image $G$
    \vspace{- .8\baselineskip}
    \item mean white image $W$, along with corresponding pixelwise SDs, minima and maxima
    \vspace{- .8\baselineskip}
    \item list of coordinates of identified bad pixel locations
\end{itemize}

\nb{can extra pixels be added to the map by operator? check manual} However, no further tools are provided \nb{?} to assess the severity of any defects, or otherwise to quantify the detector's performance, and it is likely that many operators rely on the detector software to identify defects.



\nb{Note that some features may not be taken into consideration by bad pixel map, eg. spots on screen (not fixed by SC)}

\end{document}
